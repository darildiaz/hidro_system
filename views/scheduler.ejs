<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    
    <!-- Meta tags para prevenir HTTPS -->
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Origin-Agent-Cluster" content="?0">
    
    <%- include('partials/cdn-links') %>
</head>
<body>
    <%- include('partials/navbar') %>

    <!-- Espaciador para el contenido debajo de la navbar fija -->
    <div style="height: 80px;"></div>

    <div class="container-fluid page-content">
        <!-- Hero Section -->
        <div class="hero-section">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-lg-8">
                        <h1 class="display-4 fw-bold">
                            <i class="bi bi-clock"></i>
                            Programador de Rel√©s
                        </h1>
                        <p class="lead">Configura horarios y condiciones para automatizar tu sistema hidrop√≥nico</p>
                    </div>
                    <div class="col-lg-4 text-center">
                        <div class="d-flex flex-column gap-3">
                            <!-- Reloj del Sistema -->
                            <div class="system-clock">
                                <div class="clock-time" id="system-clock">--:--:--</div>
                                <div class="clock-date" id="system-date">--/--/----</div>
                            </div>
                            
                            <a href="/" class="btn btn-hidro-outline">
                                <i class="bi bi-arrow-left"></i> Volver al Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="container">
    <!-- ===== HEADER ===== -->
    <div class="header">
        <h1>üìÖ Programador de Riego</h1>
        <p class="subtitle">Configuraci√≥n Autom√°tica de V√°lvulas</p>
    </div>

    <!-- ===== RELOJ DEL SISTEMA ===== -->
    <div class="system-clock">
        <div class="clock-time" id="clock-time">--:--:--</div>
        <div class="clock-date" id="clock-date">--/--/----</div>
    </div>

    <!-- ===== PESTA√ëAS DE V√ÅLVULAS ===== -->
    <div class="section">
        <h3>‚öôÔ∏è Configuraci√≥n por V√°lvula</h3>
        
        <ul class="nav nav-tabs" id="valveTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="valve1-tab" data-bs-toggle="tab" data-bs-target="#valve1" type="button" role="tab">
                    üíß V√°lvula 1
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="valve2-tab" data-bs-toggle="tab" data-bs-target="#valve2" type="button" role="tab">
                    üíß V√°lvula 2
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="valve3-tab" data-bs-toggle="tab" data-bs-target="#valve3" type="button" role="tab">
                    üíß V√°lvula 3
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="valve4-tab" data-bs-toggle="tab" data-bs-target="#valve4" type="button" role="tab">
                    üíß V√°lvula 4
                </button>
            </li>
        </ul>

        <div class="tab-content" id="valveTabsContent">
            <!-- V√°lvula 1 -->
            <div class="tab-pane fade show active" id="valve1" role="tabpanel">
                <div class="relay-grid">
                    <div class="info-card">
                        <h4>‚è∞ Programaci√≥n por Horario</h4>
                        <form id="schedule-form-1">
                            <div class="mb-3">
                                <label class="form-label">Hora de Inicio</label>
                                <input type="time" class="form-control" name="startTime" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Duraci√≥n (minutos)</label>
                                <input type="number" class="form-control" name="duration" min="1" max="1440" value="15" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">D√≠as de la Semana</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="1" id="day1-1">
                                    <label class="form-check-label" for="day1-1">Lunes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="2" id="day2-1">
                                    <label class="form-check-label" for="day2-1">Martes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="3" id="day3-1">
                                    <label class="form-check-label" for="day3-1">Mi√©rcoles</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="4" id="day4-1">
                                    <label class="form-check-label" for="day4-1">Jueves</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="5" id="day5-1">
                                    <label class="form-check-label" for="day5-1">Viernes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="6" id="day6-1">
                                    <label class="form-check-label" for="day6-1">S√°bado</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="0" id="day7-1">
                                    <label class="form-check-label" for="day7-1">Domingo</label>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-on">üíæ Guardar Programaci√≥n</button>
                        </form>
                    </div>

                    <div class="info-card">
                        <h4>üå°Ô∏è Activaci√≥n por Condiciones</h4>
                        <form id="condition-form-1">
                            <div class="mb-3">
                                <label class="form-label">Tipo de Condici√≥n</label>
                                <select class="form-control" name="conditionType" required>
                                    <option value="temperature">Temperatura</option>
                                    <option value="humidity">Humedad</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Valor Umbral</label>
                                <input type="number" class="form-control" name="threshold" step="0.1" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Duraci√≥n (minutos)</label>
                                <input type="number" class="form-control" name="duration" min="1" max="1440" value="15" required>
                            </div>
                            <button type="submit" class="btn btn-on">üíæ Guardar Condici√≥n</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- V√°lvula 2 -->
            <div class="tab-pane fade" id="valve2" role="tabpanel">
                <div class="relay-grid">
                    <div class="info-card">
                        <h4>‚è∞ Programaci√≥n por Horario</h4>
                        <form id="schedule-form-2">
                            <div class="mb-3">
                                <label class="form-label">Hora de Inicio</label>
                                <input type="time" class="form-control" name="startTime" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Duraci√≥n (minutos)</label>
                                <input type="number" class="form-control" name="duration" min="1" max="1440" value="15" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">D√≠as de la Semana</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="1" id="day1-2">
                                    <label class="form-check-label" for="day1-2">Lunes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="2" id="day2-2">
                                    <label class="form-check-label" for="day2-2">Martes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="3" id="day3-2">
                                    <label class="form-check-label" for="day3-2">Mi√©rcoles</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="4" id="day4-2">
                                    <label class="form-check-label" for="day4-2">Jueves</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="5" id="day5-2">
                                    <label class="form-check-label" for="day5-2">Viernes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="6" id="day6-2">
                                    <label class="form-check-label" for="day6-2">S√°bado</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="0" id="day7-2">
                                    <label class="form-check-label" for="day7-2">Domingo</label>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-on">üíæ Guardar Programaci√≥n</button>
                        </form>
                    </div>

                    <div class="info-card">
                        <h4>üå°Ô∏è Activaci√≥n por Condiciones</h4>
                        <form id="condition-form-2">
                            <div class="mb-3">
                                <label class="form-label">Tipo de Condici√≥n</label>
                                <select class="form-control" name="conditionType" required>
                                    <option value="temperature">Temperatura</option>
                                    <option value="humidity">Humedad</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Valor Umbral</label>
                                <input type="number" class="form-control" name="threshold" step="0.1" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Duraci√≥n (minutos)</label>
                                <input type="number" class="form-control" name="duration" min="1" max="1440" value="15" required>
                            </div>
                            <button type="submit" class="btn btn-on">üíæ Guardar Condici√≥n</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- V√°lvula 3 -->
            <div class="tab-pane fade" id="valve3" role="tabpanel">
                <div class="relay-grid">
                    <div class="info-card">
                        <h4>‚è∞ Programaci√≥n por Horario</h4>
                        <form id="schedule-form-3">
                            <div class="mb-3">
                                <label class="form-label">Hora de Inicio</label>
                                <input type="time" class="form-control" name="startTime" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Duraci√≥n (minutos)</label>
                                <input type="number" class="form-control" name="duration" min="1" max="1440" value="15" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">D√≠as de la Semana</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="1" id="day1-3">
                                    <label class="form-check-label" for="day1-3">Lunes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="2" id="day2-3">
                                    <label class="form-check-label" for="day2-3">Martes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="3" id="day3-3">
                                    <label class="form-check-label" for="day3-3">Mi√©rcoles</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="4" id="day4-3">
                                    <label class="form-check-label" for="day4-3">Jueves</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="5" id="day5-3">
                                    <label class="form-check-label" for="day5-3">Viernes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="6" id="day6-3">
                                    <label class="form-check-label" for="day6-3">S√°bado</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="0" id="day7-3">
                                    <label class="form-check-label" for="day7-3">Domingo</label>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-on">üíæ Guardar Programaci√≥n</button>
                        </form>
                    </div>

                    <div class="info-card">
                        <h4>üå°Ô∏è Activaci√≥n por Condiciones</h4>
                        <form id="condition-form-3">
                            <div class="mb-3">
                                <label class="form-label">Tipo de Condici√≥n</label>
                                <select class="form-control" name="conditionType" required>
                                    <option value="temperature">Temperatura</option>
                                    <option value="humidity">Humedad</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Valor Umbral</label>
                                <input type="number" class="form-control" name="threshold" step="0.1" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Duraci√≥n (minutos)</label>
                                <input type="number" class="form-control" name="duration" min="1" max="1440" value="15" required>
                            </div>
                            <button type="submit" class="btn btn-on">üíæ Guardar Condici√≥n</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- V√°lvula 4 -->
            <div class="tab-pane fade" id="valve4" role="tabpanel">
                <div class="relay-grid">
                    <div class="info-card">
                        <h4>‚è∞ Programaci√≥n por Horario</h4>
                        <form id="schedule-form-4">
                            <div class="mb-3">
                                <label class="form-label">Hora de Inicio</label>
                                <input type="time" class="form-control" name="startTime" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Duraci√≥n (minutos)</label>
                                <input type="number" class="form-control" name="duration" min="1" max="1440" value="15" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">D√≠as de la Semana</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="1" id="day1-4">
                                    <label class="form-check-label" for="day1-4">Lunes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="2" id="day2-4">
                                    <label class="form-check-label" for="day2-4">Martes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="3" id="day3-4">
                                    <label class="form-check-label" for="day3-4">Mi√©rcoles</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="4" id="day4-4">
                                    <label class="form-check-label" for="day4-4">Jueves</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="5" id="day5-4">
                                    <label class="form-check-label" for="day5-4">Viernes</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="6" id="day6-4">
                                    <label class="form-check-label" for="day6-4">S√°bado</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" name="days" value="0" id="day7-4">
                                    <label class="form-check-label" for="day7-4">Domingo</label>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-on">üíæ Guardar Programaci√≥n</button>
                        </form>
                    </div>

                    <div class="info-card">
                        <h4>üå°Ô∏è Activaci√≥n por Condiciones</h4>
                        <form id="condition-form-4">
                            <div class="mb-3">
                                <label class="form-label">Tipo de Condici√≥n</label>
                                <select class="form-control" name="conditionType" required>
                                    <option value="temperature">Temperatura</option>
                                    <option value="humidity">Humedad</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Valor Umbral</label>
                                <input type="number" class="form-control" name="threshold" step="0.1" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Duraci√≥n (minutos)</label>
                                <input type="number" class="form-control" name="duration" min="1" max="1440" value="15" required>
                            </div>
                            <button type="submit" class="btn btn-on">üíæ Guardar Condici√≥n</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== CONTROL DEL PROGRAMADOR ===== -->
    <div class="section">
        <h3>üéõÔ∏è Control del Programador</h3>
        <div class="relay-grid">
            <div class="info-card">
                <h4>‚ñ∂Ô∏è Estado del Programador</h4>
                <div class="mb-3">
                    <span class="badge bg-success" id="scheduler-status">Activo</span>
                </div>
                <button class="btn btn-on" onclick="startScheduler()">‚ñ∂Ô∏è Iniciar</button>
                <button class="btn btn-off" onclick="stopScheduler()">‚èπÔ∏è Detener</button>
            </div>

            <div class="info-card">
                <h4>üìä Programaciones Activas</h4>
                <div id="active-schedules">
                    <p>Cargando programaciones...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== FOOTER ===== -->
    <div class="footer">
        <p>Sistema AutoHidro - Programador de Riego Automatizado</p>
        <p>Configuraci√≥n Inteligente de Hidropon√≠a</p>
    </div>
</div>

<%- include('partials/cdn-scripts') %>

<script>
// ===== VARIABLES GLOBALES =====
let schedulerActive = true;

// ===== INICIALIZACI√ìN =====
document.addEventListener('DOMContentLoaded', function() {
    initializeClock();
    loadSchedules();
    loadConditions();
    setupFormHandlers();
});

// ===== RELOJ DEL SISTEMA =====
function initializeClock() {
    function updateClock() {
        const now = new Date();
        const timeString = now.toLocaleTimeString('es-ES');
        const dateString = now.toLocaleDateString('es-ES');
        
        document.getElementById('clock-time').textContent = timeString;
        document.getElementById('clock-date').textContent = dateString;
    }
    
    updateClock();
    setInterval(updateClock, 1000);
}

// ===== MANEJADORES DE FORMULARIOS =====
function setupFormHandlers() {
    // Programaciones
    for (let i = 1; i <= 4; i++) {
        document.getElementById(`schedule-form-${i}`).addEventListener('submit', function(e) {
            e.preventDefault();
            saveSchedule(i, this);
        });
        
        document.getElementById(`condition-form-${i}`).addEventListener('submit', function(e) {
            e.preventDefault();
            saveCondition(i, this);
        });
    }
}

// ===== GUARDAR PROGRAMACI√ìN =====
function saveSchedule(valveId, form) {
    const formData = new FormData(form);
    const schedule = {
        releId: valveId,
        time: formData.get('startTime'),
        duration: parseInt(formData.get('duration')),
        days: Array.from(form.querySelectorAll('input[name="days"]:checked')).map(cb => parseInt(cb.value)),
        enabled: 1
    };

    fetch('http://192.168.1.39:3000/api/scheduler/schedules', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(schedule)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Programaci√≥n guardada correctamente', 'success');
            loadSchedules();
        } else {
            showNotification(`Error: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error de comunicaci√≥n', 'error');
    });
}

// ===== GUARDAR CONDICI√ìN =====
function saveCondition(valveId, form) {
    const formData = new FormData(form);
    const condition = {
        releId: valveId,
        condition_type: formData.get('conditionType'),
        value: parseFloat(formData.get('threshold')),
        duration: parseInt(formData.get('duration')),
        enabled: 1
    };

    fetch('http://192.168.1.39:3000/api/scheduler/conditions', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(condition)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Condici√≥n guardada correctamente', 'success');
            loadConditions();
        } else {
            showNotification(`Error: ${data.error}`, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Error de comunicaci√≥n', 'error');
    });
}

// ===== CARGAR PROGRAMACIONES =====
function loadSchedules() {
    fetch('http://192.168.1.39:3000/api/scheduler/schedules')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displaySchedules(data.schedules);
            }
        })
        .catch(error => {
            console.error('Error cargando programaciones:', error);
        });
}

// ===== CARGAR CONDICIONES =====
function loadConditions() {
    fetch('http://192.168.1.39:3000/api/scheduler/conditions')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayConditions(data.conditions);
            }
        })
        .catch(error => {
            console.error('Error cargando condiciones:', error);
        });
}

// ===== MOSTRAR PROGRAMACIONES =====
function displaySchedules(schedules) {
    const container = document.getElementById('active-schedules');
    if (schedules.length === 0) {
        container.innerHTML = '<p class="text-muted">No hay programaciones activas</p>';
        return;
    }

    let html = '';
    schedules.forEach(schedule => {
        const days = schedule.days.split(',').map(d => {
            const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            return dayNames[d] || d;
        }).join(', ');
        
        html += `
            <div class="mb-2 p-2 border rounded">
                <strong>V√°lvula ${schedule.releId}</strong><br>
                <small>Hora: ${schedule.time} | Duraci√≥n: ${schedule.duration} min | D√≠as: ${days}</small>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

// ===== MOSTRAR CONDICIONES =====
function displayConditions(conditions) {
    // Implementar visualizaci√≥n de condiciones si es necesario
    console.log('Condiciones cargadas:', conditions);
}

// ===== CONTROL DEL PROGRAMADOR =====
function startScheduler() {
    fetch('http://192.168.1.39:3000/api/scheduler/start', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                schedulerActive = true;
                document.getElementById('scheduler-status').textContent = 'Activo';
                document.getElementById('scheduler-status').className = 'badge bg-success';
                showNotification('Programador iniciado', 'success');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error iniciando programador', 'error');
        });
}

function stopScheduler() {
    fetch('http://192.168.1.39:3000/api/scheduler/stop', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                schedulerActive = false;
                document.getElementById('scheduler-status').textContent = 'Detenido';
                document.getElementById('scheduler-status').className = 'badge bg-danger';
                showNotification('Programador detenido', 'warning');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Error deteniendo programador', 'error');
        });
}

// ===== NOTIFICACIONES =====
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 5000);
}

// ===== FORZAR PROTOCOLO HTTP =====
function forceHttpProtocol() {
    if (window.location.protocol === 'https:') {
        window.location.href = window.location.href.replace('https:', 'http:');
    }
}

// Ejecutar al cargar
forceHttpProtocol();

// Prevenir enlaces HTTPS
document.addEventListener('click', function(e) {
    if (e.target.tagName === 'A' && e.target.href && e.target.href.startsWith('https:')) {
        e.preventDefault();
        e.target.href = e.target.href.replace('https:', 'http:');
        e.target.click();
    }
});

// Prevenir formularios HTTPS
document.addEventListener('submit', function(e) {
    if (e.target.action && e.target.action.startsWith('https:')) {
        e.preventDefault();
        e.target.action = e.target.action.replace('https:', 'http:');
        e.target.submit();
    }
});
</script>
</body>
</html> 